<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backup/Restore Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      cursor: pointer;
      background: #4F46E5;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background: #4338CA;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #output {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      min-height: 100px;
      white-space: pre-wrap;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Backup & Restore Test</h1>
  
  <div class="section">
    <h2>1. Add Test Scans</h2>
    <button onclick="addTestScans()">Add 3 Test Scans</button>
    <button onclick="showScans()">Show Current Scans</button>
    <button onclick="clearScans()">Clear All Scans</button>
  </div>

  <div class="section">
    <h2>2. Download Backup</h2>
    <button onclick="downloadBackup()">Download Backup</button>
    <p>This will download a JSON file with all scans</p>
  </div>

  <div class="section">
    <h2>3. Restore Backup</h2>
    <input type="file" id="fileInput" accept=".json">
    <button onclick="restoreBackup()">Restore from File</button>
    <p>Upload the backup file you just downloaded</p>
  </div>

  <div id="output"></div>

  <script type="module">
    const STORAGE_KEY = 'dermoscanner_history';
    
    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
    }

    window.addTestScans = function() {
      const scans = [
        {
          id: 'test-' + Date.now() + '-1',
          userId: 'user-123',
          result: 'benign',
          confidence: 0.87,
          processingTime: 3200,
          timestamp: new Date().toISOString()
        },
        {
          id: 'test-' + Date.now() + '-2',
          userId: 'user-123',
          result: 'suspicious',
          confidence: 0.65,
          processingTime: 3150,
          timestamp: new Date().toISOString()
        },
        {
          id: 'test-' + Date.now() + '-3',
          userId: 'user-123',
          result: 'malignant',
          confidence: 0.92,
          processingTime: 3300,
          timestamp: new Date().toISOString()
        }
      ];

      localStorage.setItem(STORAGE_KEY, JSON.stringify(scans));
      log(`Added ${scans.length} test scans to localStorage`, 'success');
    };

    window.showScans = function() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) {
        log('No scans found in localStorage', 'error');
        return;
      }
      
      const scans = JSON.parse(stored);
      log(`Found ${scans.length} scans:`, 'success');
      scans.forEach((scan, i) => {
        log(`  ${i + 1}. ${scan.result} (${(scan.confidence * 100).toFixed(0)}%) - ${scan.timestamp}`);
      });
    };

    window.clearScans = function() {
      localStorage.removeItem(STORAGE_KEY);
      log('Cleared all scans from localStorage', 'success');
    };

    window.downloadBackup = function() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) {
        log('No scans to backup', 'error');
        return;
      }

      const scans = JSON.parse(stored);
      const blob = new Blob([JSON.stringify(scans, null, 2)], {
        type: 'application/json'
      });
      
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `dermoscanner-backup-${Date.now()}.json`;
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      log(`Backup downloaded: ${scans.length} scans`, 'success');
    };

    window.restoreBackup = function() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        log('Please select a file first', 'error');
        return;
      }

      if (!file.name.endsWith('.json')) {
        log('Invalid file type. Please upload a JSON file.', 'error');
        return;
      }

      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const content = e.target.result;
          const restoredScans = JSON.parse(content);
          
          if (!Array.isArray(restoredScans)) {
            log('Invalid backup file format. Expected an array.', 'error');
            return;
          }

          // Validate structure
          const isValid = restoredScans.every(scan => {
            return scan.id && scan.userId && scan.result && 
                   typeof scan.confidence === 'number' && 
                   typeof scan.processingTime === 'number' && 
                   scan.timestamp;
          });

          if (!isValid) {
            log('Invalid backup file. Some scans are missing required fields.', 'error');
            return;
          }

          // Get existing scans
          const existingStored = localStorage.getItem(STORAGE_KEY);
          const existingScans = existingStored ? JSON.parse(existingStored) : [];
          const existingIds = new Set(existingScans.map(s => s.id));

          // Merge: only add scans that don't already exist
          let addedCount = 0;
          restoredScans.forEach(scan => {
            if (!existingIds.has(scan.id)) {
              existingScans.push(scan);
              addedCount++;
            }
          });

          localStorage.setItem(STORAGE_KEY, JSON.stringify(existingScans));
          
          log(`Backup restored successfully!`, 'success');
          log(`  - ${addedCount} new scans added`, 'success');
          log(`  - ${restoredScans.length - addedCount} duplicates skipped`, 'success');
          log(`  - Total scans: ${existingScans.length}`, 'success');
          
        } catch (error) {
          log(`Error: ${error.message}`, 'error');
        }
      };

      reader.onerror = () => {
        log('Failed to read file', 'error');
      };

      reader.readAsText(file);
    };

    // Initial message
    log('Backup/Restore test page loaded. Start by adding test scans.');
  </script>
</body>
</html>
